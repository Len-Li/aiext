<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>LaTeX和代码块渲染测试</title>\n    <style>\n        body {\n            font-family: Arial, sans-serif;\n            max-width: 800px;\n            margin: 0 auto;\n            padding: 20px;\n            line-height: 1.6;\n        }\n        .test-section {\n            margin: 20px 0;\n            padding: 15px;\n            border: 1px solid #ddd;\n            border-radius: 5px;\n            background: #f9f9f9;\n        }\n        .test-title {\n            font-weight: bold;\n            color: #333;\n            margin-bottom: 10px;\n        }\n        .input {\n            background: #f5f5f5;\n            padding: 10px;\n            border-radius: 3px;\n            font-family: monospace;\n            font-size: 14px;\n            white-space: pre-wrap;\n            margin: 10px 0;\n        }\n        .output {\n            background: #fff;\n            padding: 15px;\n            border-radius: 3px;\n            border: 1px solid #ddd;\n            margin: 10px 0;\n        }\n    </style>\n    <!-- 引入KaTeX样式 -->\n    <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css\">\n    <!-- 引入highlight.js样式 -->\n    <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css\">\n</head>\n<body>\n    <h1>LaTeX公式和代码块渲染测试</h1>\n    \n    <div class=\"test-section\">\n        <div class=\"test-title\">测试1：LaTeX块级公式</div>\n        <div class=\"input\">\n$$E = mc^2$$\n\n$$\\\\int_0^\\\\infty e^{-x^2} dx = \\\\frac{\\\\sqrt{\\\\pi}}{2}$$\n        </div>\n        <div class=\"output\" id=\"test1-output\"></div>\n    </div>\n    \n    <div class=\"test-section\">\n        <div class=\"test-title\">测试2：LaTeX行内公式</div>\n        <div class=\"input\">\n这是一个行内公式 $E = mc^2$，还有另一个公式 $\\\\alpha + \\\\beta = \\\\gamma$。\n        </div>\n        <div class=\"output\" id=\"test2-output\"></div>\n    </div>\n    \n    <div class=\"test-section\">\n        <div class=\"test-title\">测试3：代码块高亮</div>\n        <div class=\"input\">\n```javascript\nfunction fibonacci(n) {\n    if (n <= 1) return n;\n    return fibonacci(n - 1) + fibonacci(n - 2);\n}\n\nconsole.log(fibonacci(10));\n```\n        </div>\n        <div class=\"output\" id=\"test3-output\"></div>\n    </div>\n    \n    <div class=\"test-section\">\n        <div class=\"test-title\">测试4：混合内容</div>\n        <div class=\"input\">\n# 数学与编程\n\n这是一个包含LaTeX公式和代码的示例。\n\n根据爱因斯坦的质能方程：\n$$E = mc^2$$\n\n我们可以写出以下JavaScript代码来计算能量：\n\n```javascript\nconst mass = 1; // kg\nconst speedOfLight = 299792458; // m/s\nconst energy = mass * Math.pow(speedOfLight, 2);\nconsole.log(`能量: ${energy} 焦耳`);\n```\n\n行内公式：$\\\\Delta E = \\\\Delta m \\\\cdot c^2$\n\n下面是Python代码：\n\n```python\ndef calculate_energy(mass):\n    c = 299792458  # 光速 m/s\n    return mass * c ** 2\n\nif __name__ == \"__main__\":\n    mass = 1.0\n    energy = calculate_energy(mass)\n    print(f\"质量为 {mass} kg 的物体能量为: {energy} J\")\n```\n        </div>\n        <div class=\"output\" id=\"test4-output\"></div>\n    </div>\n\n    <!-- 引入库脚本 -->\n    <script src=\"https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js\"></script>\n    \n    <script>\n        // 复制overlay.js中的markdownToHtml函数\n        function escapeHtml(str) {\n            return str\n                .replace(/&/g, \"&\")\n                .replace(/</g, \"<\")\n                .replace(/>/g, \">\")\n                .replace(/\"/g, \""\")\n                .replace(/'/g, \"'\");\n        }\n\n        // 渲染LaTeX公式的辅助函数\n        function renderLatex(text, displayMode = false) {\n            try {\n                if (window.katex) {\n                    return window.katex.renderToString(text, {\n                        displayMode: displayMode,\n                        throwOnError: false,\n                        output: 'html',\n                        strict: 'warn',\n                        trust: false\n                    });\n                } else {\n                    // 如果KaTeX未加载，显示原始LaTeX文本\n                    return `<pre class=\"latex-fallback\">${escapeHtml(text)}</pre>`;\n                }\n            } catch (e) {\n                console.warn('LaTeX渲染失败:', e);\n                return `<pre class=\"latex-error\">${escapeHtml(text)}</pre>`;\n            }\n        }\n\n        // 渲染代码块的辅助函数\n        function renderCodeBlock(code, language = '') {\n            try {\n                if (window.hljs) {\n                    // 尝试检测语言\n                    let lang = language.toLowerCase().trim();\n                    if (!lang || lang === 'text' || lang === 'plain') {\n                        const result = window.hljs.highlightAuto(code);\n                        return `<pre><code class=\"hljs\">${result.value}</code></pre>`;\n                    }\n                    \n                    // 尝试使用指定语言高亮\n                    try {\n                        const result = window.hljs.highlight(code, { language: lang });\n                        return `<pre><code class=\"hljs language-${lang}\">${result.value}</code></pre>`;\n                    } catch (e) {\n                        // 如果指定语言失败，自动检测\n                        const result = window.hljs.highlightAuto(code);\n                        return `<pre><code class=\"hljs\">${result.value}</code></pre>`;\n                    }\n                } else {\n                    // 如果highlight.js未加载，显示原始代码\n                    return `<pre><code>${escapeHtml(code)}</code></pre>`;\n                }\n            } catch (e) {\n                console.warn('代码高亮失败:', e);\n                return `<pre><code>${escapeHtml(code)}</code></pre>`;\n            }\n        }\n\n        function markdownToHtml(md) {\n            if (!md) return \"\";\n\n            // 临时存储LaTeX公式和代码块\n            const latexBlocks = [];\n            const codeBlocks = [];\n            \n            // 提取LaTeX公式（块级）\n            md = md.replace(/\\$\\$([\\s\\S]*?)\\$\\$/g, (match, content) => {\n                const index = latexBlocks.length;\n                latexBlocks.push({ content: content.trim(), displayMode: true });\n                return `__LATEX_BLOCK_${index}__`;\n            });\n            \n            // 提取LaTeX公式（行内）\n            md = md.replace(/\\$([^\\$\\n]+?)\\$/g, (match, content) => {\n                const index = latexBlocks.length;\n                latexBlocks.push({ content: content.trim(), displayMode: false });\n                return `__LATEX_INLINE_${index}__`;\n            });\n\n            // 处理代码块 ``` ```\n            const parts = md.split(/```/);\n            let html = \"\";\n            parts.forEach((part, index) => {\n                if (index % 2 === 1) {\n                    // 代码块\n                    const lines = part.split('\\n');\n                    let language = '';\n                    let code = part;\n                    \n                    // 检查第一行是否为语言标识符\n                    if (lines.length > 1 && /^[a-zA-Z0-9_-]+$/.test(lines[0].trim())) {\n                        language = lines[0].trim();\n                        code = lines.slice(1).join('\\n');\n                    }\n                    \n                    code = code.replace(/^\\s+|\\s+$/g, \"\");\n                    const codeIndex = codeBlocks.length;\n                    codeBlocks.push({ code: code, language: language });\n                    html += `__CODE_BLOCK_${codeIndex}__`;\n                } else {\n                    // 普通文本部分做简单 markdown 处理\n                    let text = escapeHtml(part);\n                    \n                    // 按行处理，更精确地控制标题和换行\n                    const lines = text.split('\\n');\n                    const processedLines = [];\n                    \n                    for (let i = 0; i < lines.length; i++) {\n                        const line = lines[i];\n                        // 检查是否是标题行\n                        const titleMatch = line.match(/^\\s*(#{1,6})\\s+(.+?)\\s*$/);\n                        if (titleMatch) {\n                            const level = titleMatch[1].length;\n                            const content = titleMatch[2];\n                            processedLines.push(`<h${level}>${content}</h${level}>`);\n                        } else {\n                            // 非标题行，保留原样（后续会处理换行）\n                            processedLines.push(line);\n                        }\n                    }\n                    \n                    text = processedLines.join('\\n');\n                    \n                    // 粗体 **text**\n                    text = text.replace(/\\*\\*(.+?)\\*\\*/g, \"<strong>$1</strong>\");\n                    // 行内代码 `code`\n                    text = text.replace(/`([^`]+)`/g, \"<code>$1</code>\");\n                    // 无序列表 - / * 开头的行（转成前缀符号）\n                    text = text.replace(\n                        /(^|\\n)[\\-\\*]\\s+(.+?)(?=\\n|$)/g,\n                        (_, p1, p2) => `${p1}• ${p2}`\n                    );\n                    // 网址自动变链接（简单判断）\n                    text = text.replace(\n                        /(https?:\\/\\/[^\\s]+)/g,\n                        '<a href=\"$1\" target=\"_blank\" rel=\"noopener noreferrer\">$1</a>'\n                    );\n                    \n                    // 换行处理：标题标签是块级元素，前后不需要 <br>\n                    // 移除标题前后的换行符\n                    text = text.replace(/\\n\\s*(<\\/?h[1-6][^>]*>)\\s*\\n/g, '$1');\n                    text = text.replace(/\\n\\s*(<\\/?h[1-6][^>]*>)/g, '$1');\n                    text = text.replace(/(<\\/?h[1-6][^>]*>)\\s*\\n/g, '$1');\n                    // 处理剩余的换行\n                    text = text.replace(/\\n/g, \"<br>\");\n                    html += text;\n                }\n            });\n\n            // 替换回LaTeX公式\n            html = html.replace(/__LATEX_BLOCK_(\\d+)__/g, (match, index) => {\n                const latex = latexBlocks[parseInt(index)];\n                return renderLatex(latex.content, true);\n            });\n            \n            html = html.replace(/__LATEX_INLINE_(\\d+)__/g, (match, index) => {\n                const latex = latexBlocks[parseInt(index)];\n                return renderLatex(latex.content, false);\n            });\n            \n            // 替换回代码块\n            html = html.replace(/__CODE_BLOCK_(\\d+)__/g, (match, index) => {\n                const codeBlock = codeBlocks[parseInt(index)];\n                return renderCodeBlock(codeBlock.code, codeBlock.language);\n            });\n\n            return html;\n        }\n        \n        // 测试函数\n        function runTests() {\n            const tests = [\n                {\n                    input: document.querySelector('.test-section:nth-child(2) .input').textContent,\n                    outputId: 'test1-output'\n                },\n                {\n                    input: document.querySelector('.test-section:nth-child(4) .input').textContent,\n                    outputId: 'test2-output'\n                },\n                {\n                    input: document.querySelector('.test-section:nth-child(6) .input').textContent,\n                    outputId: 'test3-output'\n                },\n                {\n                    input: document.querySelector('.test-section:nth-child(8) .input').textContent,\n                    outputId: 'test4-output'\n                }\n            ];\n            \n            tests.forEach((test, index) => {\n                try {\n                    const output = markdownToHtml(test.input);\n                    document.getElementById(test.outputId).innerHTML = output;\n                } catch (e) {\n                    document.getElementById(test.outputId).innerHTML = `<span style=\"color: red;\">渲染失败: ${e.message}</span>`;\n                }\n            });\n        }\n        \n        // 等待库加载完成后运行测试\n        window.addEventListener('load', () => {\n            setTimeout(runTests, 1000);\n        });\n    </script>\n</body>\n</html>